const Q="https://stackblitz.com",X=new Error;X.stack="";const S={};let g=null;const v={get editorOrigin(){return g==null&&(g=new URL(globalThis.WEBCONTAINER_API_IFRAME_URL??Q).origin),g},set editorOrigin(e){g=new URL(e).origin},setQueryParam(e,t){S[e]=t},get url(){const e=new URL(this.editorOrigin);e.pathname="/headless";for(const t in S)e.searchParams.set(t,S[t]);return e.searchParams.set("version","1.6.1"),e}};function $(){let e,t;function r(){t=new Promise(n=>e=n)}return r(),{get promise(){return t},resolve(n){return e(n)},reset:r}}$();var _;(function(e){e.UncaughtException="PREVIEW_UNCAUGHT_EXCEPTION",e.UnhandledRejection="PREVIEW_UNHANDLED_REJECTION",e.ConsoleError="PREVIEW_CONSOLE_ERROR"})(_||(_={}));var K=Object.defineProperty,Z=(e,t)=>{for(var r in t)K(e,r,{get:t[r],enumerable:!0})},d={};Z(d,{createEndpoint:()=>F,expose:()=>C,proxy:()=>H,proxyMarker:()=>L,releaseProxy:()=>M,transfer:()=>W,transferHandlers:()=>A,windowEndpoint:()=>se,wrap:()=>z});var L=Symbol("Comlink.proxy"),F=Symbol("Comlink.endpoint"),M=Symbol("Comlink.releaseProxy"),I=Symbol("Comlink.thrown"),D=e=>typeof e=="object"&&e!==null||typeof e=="function",ee={canHandle:e=>D(e)&&e[L],serialize(e){const{port1:t,port2:r}=new MessageChannel;return C(e,t),[r,[r]]},deserialize(e){return e.start(),z(e)}},te={canHandle:e=>D(e)&&I in e,serialize({value:e}){let t;return e instanceof Error?t={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:t={isError:!1,value:e},[t,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},A=new Map([["proxy",ee],["throw",te]]);function C(e,t=self){t.addEventListener("message",function r(n){if(!n||!n.data)return;const{id:s,type:i,path:o}=Object.assign({path:[]},n.data),a=(n.data.argumentList||[]).map(p);let c;try{const l=o.slice(0,-1).reduce((u,w)=>u[w],e),f=o.reduce((u,w)=>u[w],e);switch(i){case 0:c=f;break;case 1:l[o.slice(-1)[0]]=p(n.data.value),c=!0;break;case 2:c=f.apply(l,a);break;case 3:{const u=new f(...a);c=H(u)}break;case 4:{const{port1:u,port2:w}=new MessageChannel;C(e,w),c=W(u,[u])}break;case 5:c=void 0;break}}catch(l){c={value:l,[I]:0}}Promise.resolve(c).catch(l=>({value:l,[I]:0})).then(l=>{const[f,u]=N(l);t.postMessage(Object.assign(Object.assign({},f),{id:s}),u),i===5&&(t.removeEventListener("message",r),j(t))})}),t.start&&t.start()}function re(e){return e.constructor.name==="MessagePort"}function j(e){re(e)&&e.close()}function z(e,t){return O(e,[],t)}function b(e){if(e)throw new Error("Proxy has been released and is not useable")}function O(e,t=[],r=function(){}){let n=!1;const s=new Proxy(r,{get(i,o){if(b(n),o===M)return()=>m(e,{type:5,path:t.map(a=>a.toString())}).then(()=>{j(e),n=!0});if(o==="then"){if(t.length===0)return{then:()=>s};const a=m(e,{type:0,path:t.map(c=>c.toString())}).then(p);return a.then.bind(a)}return O(e,[...t,o])},set(i,o,a){b(n);const[c,l]=N(a);return m(e,{type:1,path:[...t,o].map(f=>f.toString()),value:c},l).then(p)},apply(i,o,a){b(n);const c=t[t.length-1];if(c===F)return m(e,{type:4}).then(p);if(c==="bind")return O(e,t.slice(0,-1));const[l,f]=U(a);return m(e,{type:2,path:t.map(u=>u.toString()),argumentList:l},f).then(p)},construct(i,o){b(n);const[a,c]=U(o);return m(e,{type:3,path:t.map(l=>l.toString()),argumentList:a},c).then(p)}});return s}function ne(e){return Array.prototype.concat.apply([],e)}function U(e){const t=e.map(N);return[t.map(r=>r[0]),ne(t.map(r=>r[1]))]}var V=new WeakMap;function W(e,t){return V.set(e,t),e}function H(e){return Object.assign(e,{[L]:!0})}function se(e,t=self,r="*"){return{postMessage:(n,s)=>e.postMessage(n,r,s),addEventListener:t.addEventListener.bind(t),removeEventListener:t.removeEventListener.bind(t)}}function N(e){for(const[t,r]of A)if(r.canHandle(e)){const[n,s]=r.serialize(e);return[{type:3,name:t,value:n},s]}return[{type:0,value:e},V.get(e)||[]]}function p(e){switch(e.type){case 3:return A.get(e.name).deserialize(e.value);case 0:return e.value}}function m(e,t,r){return new Promise(n=>{const s=ie();e.addEventListener("message",function i(o){!o.data||!o.data.id||o.data.id!==s||(e.removeEventListener("message",i),n(o.data))}),e.start&&e.start(),e.postMessage(Object.assign({id:s},t),r)})}function ie(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}const oe=[_.ConsoleError,_.UncaughtException,_.UnhandledRejection];function ae(e){return!(e==null||typeof e!="object"||!("type"in e)||!oe.includes(e.type))}function y(e){const t=Object.create(null);return e?Object.assign(t,e):t}const ce=new TextDecoder("latin1");function B(e){const t={d:{}};for(const r of Object.keys(e)){const n=e[r];if("file"in n){if("symlink"in n.file){t.d[r]={f:{l:n.file.symlink}};continue}const i=n.file.contents,o=typeof i=="string"?i:ce.decode(i),a=typeof i=="string"?{}:{b:!0};t.d[r]={f:{c:o,...a}};continue}const s=B(n.directory);t.d[r]=s}return t}function G(e){const t=y();if("f"in e)throw new Error("It is not possible to export a single file in the JSON format.");if("d"in e)for(const r of Object.keys(e.d)){const n=e.d[r];"d"in n?t[r]=y({directory:G(n)}):"f"in n&&("c"in n.f?t[r]=y({file:y({contents:n.f.b?le(n.f.c):n.f.c})}):"l"in n.f&&(t[r]=y({file:y({symlink:n.f.l})})))}return t}function le(e){const t=new Uint8Array(e.length);for(let r=0;r<e.length;r++)t[r]=e[r].charCodeAt(0);return t}let E=null,P=null,k={};const Y=new TextDecoder,ue=new TextEncoder;class h{_instance;_runtimeInfo;fs;static _instance=null;static _teardownPromise=null;_tornDown=!1;_unsubscribeFromTokenChangedListener=()=>{};constructor(t,r,n,s){this._instance=t,this._runtimeInfo=s,this.fs=new me(r)}async spawn(t,r,n){let s=[];Array.isArray(r)?s=r:n=r;let i,o=new ReadableStream;if(n?.output!==!1){const T=Ee();i=T.push,o=T.stream}let a,c,l,f;const u=x(R(i)),w=x(R(a)),q=x(R(l)),J=await this._instance.run({command:t,args:s,cwd:n?.cwd,env:n?.env,terminal:n?.terminal},w,q,u);return new pe(J,o,c,f)}async export(t,r){const n={format:r?.format??"json",includes:r?.includes,excludes:r?.excludes,external:!0},s=await this._instance.serialize(t,n);if(n.format==="json"){const i=JSON.parse(Y.decode(s));return G(i)}return s}on(t,r){if(t==="preview-message"){const i=r;r=(o=>{ae(o)&&i(o)})}const{listener:n,subscribe:s}=Pe(r);return s(this._instance.on(t,d.proxy(n)))}mount(t,r){const n=t instanceof Uint8Array?t:t instanceof ArrayBuffer?new Uint8Array(t):ue.encode(JSON.stringify(B(t)));return this._instance.loadFiles(d.transfer(n,[n.buffer]),{mountPoints:r?.mountPoint})}setPreviewScript(t,r){return this._instance.setPreviewScript(t,r)}get path(){return this._runtimeInfo.path}get workdir(){return this._runtimeInfo.cwd}teardown(){if(this._tornDown)throw new Error("WebContainer already torn down");this._tornDown=!0,this._unsubscribeFromTokenChangedListener();const t=async()=>{try{await this.fs._teardown(),await this._instance.teardown()}finally{this._instance[d.releaseProxy](),h._instance===this&&(h._instance=null)}};h._teardownPromise=t()}static async boot(t={}){await this._teardownPromise,h._teardownPromise=null;const{workdirName:r}=t;if(window.crossOriginIsolated&&t.coep==="none"&&console.warn(`A Cross-Origin-Embedder-Policy header is required in cross origin isolated environments.
Set the 'coep' option to 'require-corp'.`),r?.includes("/")||r===".."||r===".")throw new Error("workdirName should be a valid folder name");for(;E;)await E;if(h._instance)throw new Error("Only a single WebContainer instance can be booted");const n=ye(t);E=n.catch(()=>{});try{const s=await n;return h._instance=s,s}finally{E=null}}}const fe=1,de=2;class he{name;_type;constructor(t,r){this.name=t,this._type=r}isFile(){return this._type===fe}isDirectory(){return this._type===de}}class we{_apiClient;_path;_options;_listener;_wrappedListener;_watcher;_closed=!1;constructor(t,r,n,s){this._apiClient=t,this._path=r,this._options=n,this._listener=s,this._apiClient._watchers.add(this),this._wrappedListener=(i,o)=>{this._listener&&!this._closed&&this._listener(i,o)},this._apiClient._fs.watch(this._path,this._options,x(this._wrappedListener)).then(i=>{if(this._watcher=i,this._closed)return this._teardown()}).catch(console.error)}async close(){this._closed||(this._closed=!0,this._apiClient._watchers.delete(this),await this._teardown())}async _teardown(){await this._watcher?.close().finally(()=>{this._watcher?.[d.releaseProxy]()})}}class pe{output;input;exit;_process;stdout;stderr;constructor(t,r,n,s){this.output=r,this._process=t,this.input=new WritableStream({write:i=>{this._getProcess()?.write(i).catch(()=>{})}}),this.exit=this._onExit(),this.stdout=n,this.stderr=s}kill(){this._process?.kill()}resize(t){this._getProcess()?.resize(t)}async _onExit(){try{return await this._process.onExit}finally{this._process?.[d.releaseProxy](),this._process=null}}_getProcess(){return this._process==null&&console.warn("This process already exited"),this._process}}class me{_fs;_watchers=new Set([]);constructor(t){this._fs=t}rm(...t){return this._fs.rm(...t)}async readFile(t,r){return await this._fs.readFile(t,r)}async rename(t,r){return await this._fs.rename(t,r)}async writeFile(t,r,n){if(r instanceof Uint8Array){const s=r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength);r=d.transfer(new Uint8Array(s),[s])}await this._fs.writeFile(t,r,n)}async readdir(t,r){const n=await this._fs.readdir(t,r);return ge(n)||be(n)?n:n.map(i=>new he(i.name,i["Symbol(type)"]))}async mkdir(t,r){return await this._fs.mkdir(t,r)}watch(t,r,n){return typeof r=="function"&&(n=r,r=null),new we(this,t,r,n)}async _teardown(){this._fs[d.releaseProxy](),await Promise.all([...this._watchers].map(t=>t.close()))}}async function ye(e){const{serverPromise:t}=_e(e),n=await(await t).build({host:window.location.host,version:"1.6.1",workdirName:e.workdirName,forwardPreviewErrors:e.forwardPreviewErrors}),[s,i,o]=await Promise.all([n.fs(),n.previewScript(),n.runtimeInfo()]);return new h(n,s,i,o)}function R(e){if(e!=null)return t=>{t instanceof Uint8Array?e(Y.decode(t)):t==null&&e(null)}}function x(e){if(e!=null)return d.proxy(e)}function _e(e){if(P!=null)return e.coep!==k.coep&&(console.warn(`Attempting to boot WebContainer with 'coep: ${e.coep}'`),console.warn(`First boot had 'coep: ${k.coep}', new settings will not take effect!`)),{serverPromise:P};e.coep&&v.setQueryParam("coep",e.coep),e.experimentalNode&&v.setQueryParam("experimental_node","1");const t=document.createElement("iframe");t.style.display="none",t.setAttribute("allow","cross-origin-isolated");const r=v.url;t.src=r.toString();const{origin:n}=r;return k={...e},P=new Promise(s=>{const i=o=>{if(o.origin!==n)return;const{data:a}=o;if(a.type==="init"){s(d.wrap(o.ports[0]));return}if(a.type==="warning"){console[a.level].call(console,a.message);return}};window.addEventListener("message",i)}),document.body.insertBefore(t,null),{serverPromise:P}}function ge(e){return typeof e[0]=="string"}function be(e){return e[0]instanceof Uint8Array}function Ee(){let e=null;return{stream:new ReadableStream({start(n){e=n}}),push:n=>{n!=null?e?.enqueue(n):(e?.close(),e=null)}}}function Pe(e){let t=!1,r=()=>{};return{subscribe(s){return s.then(i=>{r=i,t&&r()}),()=>{t=!0,r()}},listener:((...s)=>{t||e(...s)})}}export{_ as PreviewMessageType,h as WebContainer,ae as isPreviewMessage};
